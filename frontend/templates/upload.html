<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendaVoa - Teste de Upload</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            max-width: 800px; 
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo { 
            font-size: 2rem; 
            text-align: center;
            margin-bottom: 2rem;
            color: #2563eb;
        }
        h2 { 
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }
        .section {
            margin-bottom: 40px;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 10px;
        }
        .form-group { 
            margin-bottom: 20px; 
        }
        label { 
            display: block; 
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select { 
            width: 100%; 
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button { 
            width: 100%; 
            padding: 12px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { 
            background: #1d4ed8;
        }
        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .file-input {
            border: 2px dashed #2563eb;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-input:hover {
            background: #e2e8f0;
        }
        .file-input.dragover {
            border-color: #1d4ed8;
            background: #dbeafe;
        }
        .preview {
            margin-top: 20px;
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
        }
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            color: #2563eb;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/dashboard" class="back-btn">‚Üê Voltar ao Dashboard</a>
        
        <div class="logo">üìÅ Upload de Arquivos</div>
        
        <!-- Se√ß√£o para criar carro com foto -->
        <div class="section">
            <h3>üöó Criar Carro com Foto</h3>
            <div id="car-message"></div>
            <form id="car-form">
                <div class="form-group">
                    <label>T√≠tulo</label>
                    <input type="text" name="title" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Marca</label>
                        <input type="text" name="brand" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Modelo</label>
                        <input type="text" name="model" required>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Ano</label>
                        <input type="number" name="year" min="1980" max="2030" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Pre√ßo (R$)</label>
                        <input type="number" name="price" step="0.01" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <input type="text" name="observations">
                </div>
                <div class="form-group">
                    <label>Foto do Carro</label>
                    <div class="file-input" id="car-photo-drop">
                        <input type="file" id="car-photo" accept="image/*" style="display: none;">
                        <p>üì∑ Clique ou arraste uma foto aqui</p>
                        <p><small>Formatos aceitos: JPG, PNG, GIF, WebP (m√°x. 10MB)</small></p>
                    </div>
                    <img id="car-photo-preview" class="preview" style="display: none;">
                </div>
                <button type="submit">Criar Carro com Foto</button>
            </form>
        </div>

        <!-- Se√ß√£o para upload de foto em carro existente -->
        <div class="section">
            <h3>üì∑ Upload de Foto para Carro Existente</h3>
            <div id="photo-message"></div>
            <form id="photo-form">
                <div class="form-group">
                    <label>Selecionar Carro</label>
                    <select name="car_id" id="car-select" required>
                        <option value="">Carregando carros...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nova Foto</label>
                    <div class="file-input" id="photo-drop">
                        <input type="file" id="photo-file" accept="image/*" style="display: none;">
                        <p>üì∑ Clique ou arraste uma foto aqui</p>
                        <p><small>Formatos aceitos: JPG, PNG, GIF, WebP (m√°x. 10MB)</small></p>
                    </div>
                    <img id="photo-preview" class="preview" style="display: none;">
                </div>
                <button type="submit">Atualizar Foto</button>
            </form>
        </div>

        <!-- Se√ß√£o para upload de documento -->
        <div class="section">
            <h3>üìÑ Upload de Documento</h3>
            <div id="doc-message"></div>
            <form id="document-form">
                <div class="form-group">
                    <label>Selecionar Carro</label>
                    <select name="car_id" id="doc-car-select" required>
                        <option value="">Carregando carros...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nome do Documento</label>
                    <input type="text" name="name" required placeholder="Ex: Documento de Transfer√™ncia">
                </div>
                <div class="form-group">
                    <label>Tipo de Documento</label>
                    <select name="document_type" required>
                        <option value="">Selecionar tipo</option>
                        <option value="transfer">Documento de Transfer√™ncia</option>
                        <option value="registration">Certificado de Registro</option>
                        <option value="insurance">Seguro</option>
                        <option value="inspection">Vistoria</option>
                        <option value="receipt">Recibo</option>
                        <option value="contract">Contrato</option>
                        <option value="other">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <input type="text" name="notes" placeholder="Observa√ß√µes opcionais">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="is_required"> Documento obrigat√≥rio
                    </label>
                </div>
                <div class="form-group">
                    <label>Arquivo do Documento</label>
                    <div class="file-input" id="doc-drop">
                        <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" style="display: none;">
                        <p>üìÑ Clique ou arraste um arquivo aqui</p>
                        <p><small>Formatos aceitos: PDF, DOC, DOCX, JPG, PNG, TXT (m√°x. 10MB)</small></p>
                    </div>
                </div>
                <button type="submit">Criar Documento com Arquivo</button>
            </form>
        </div>
    </div>

    <script>
        // Carregar carros para os selects
        async function loadCars() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/cars/', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const cars = await response.json();
                    const carSelects = ['car-select', 'doc-car-select'];
                    
                    carSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        select.innerHTML = '<option value="">Selecionar carro</option>';
                        cars.forEach(car => {
                            select.innerHTML += `<option value="${car.id}">${car.title} - ${car.brand} ${car.model}</option>`;
                        });
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar carros:', error);
            }
        }

        // Configurar drag and drop para cada √°rea de upload
        function setupFileInput(dropAreaId, inputId, previewId = null) {
            const dropArea = document.getElementById(dropAreaId);
            const fileInput = document.getElementById(inputId);
            const preview = previewId ? document.getElementById(previewId) : null;

            dropArea.addEventListener('click', () => fileInput.click());

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('dragover');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('dragover');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    if (preview && files[0].type.startsWith('image/')) {
                        showPreview(files[0], preview);
                    }
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (preview && e.target.files[0] && e.target.files[0].type.startsWith('image/')) {
                    showPreview(e.target.files[0], preview);
                }
            });
        }

        function showPreview(file, imgElement) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imgElement.src = e.target.result;
                imgElement.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Configurar todas as √°reas de upload
        setupFileInput('car-photo-drop', 'car-photo', 'car-photo-preview');
        setupFileInput('photo-drop', 'photo-file', 'photo-preview');
        setupFileInput('doc-drop', 'doc-file');

        // Form de criar carro com foto
        document.getElementById('car-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageDiv = document.getElementById('car-message');
            
            try {
                const formData = new FormData(e.target);
                const photoFile = document.getElementById('car-photo').files[0];
                
                const token = localStorage.getItem('token');
                
                // Primeiro criar o carro
                const carData = {
                    title: formData.get('title'),
                    brand: formData.get('brand'),
                    model: formData.get('model'),
                    year: parseInt(formData.get('year')),
                    price: formData.get('price') ? parseFloat(formData.get('price')) : null,
                    observations: formData.get('observations') || null,
                    status: 'available'
                };

                const carResponse = await fetch('/api/cars/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(carData)
                });

                if (!carResponse.ok) throw new Error('Erro ao criar carro');
                
                const car = await carResponse.json();
                
                // Se h√° foto, fazer upload
                if (photoFile) {
                    const photoFormData = new FormData();
                    photoFormData.append('file', photoFile);
                    
                    const photoResponse = await fetch(`/api/cars/upload-photo/${car.id}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: photoFormData
                    });
                    
                    if (!photoResponse.ok) throw new Error('Erro ao fazer upload da foto');
                }
                
                messageDiv.innerHTML = '<div class="alert alert-success">Carro criado com sucesso!</div>';
                e.target.reset();
                document.getElementById('car-photo-preview').style.display = 'none';
                loadCars(); // Atualizar lista de carros
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });

        // Form de upload de foto
        document.getElementById('photo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageDiv = document.getElementById('photo-message');
            
            try {
                const formData = new FormData();
                const carId = e.target.car_id.value;
                const photoFile = document.getElementById('photo-file').files[0];
                
                if (!photoFile) throw new Error('Selecione uma foto');
                
                formData.append('file', photoFile);
                
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/cars/upload-photo/${carId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success">Foto atualizada com sucesso!</div>';
                    e.target.reset();
                    document.getElementById('photo-preview').style.display = 'none';
                } else {
                    throw new Error('Erro no upload da foto');
                }
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });

        // Form de upload de documento
        document.getElementById('document-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageDiv = document.getElementById('doc-message');
            
            try {
                const carId = e.target.car_id.value;
                const docFile = document.getElementById('doc-file').files[0];
                
                if (!docFile) throw new Error('Selecione um arquivo');
                
                const formData = new FormData();
                formData.append('file', docFile);
                formData.append('name', e.target.name.value);
                formData.append('document_type', e.target.document_type.value);
                formData.append('notes', e.target.notes.value || '');
                formData.append('is_required', e.target.is_required.checked);
                
                const token = localStorage.getItem('token');
                const response = await fetch(`/docs/create-with-file/${carId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="alert alert-success">Documento criado com sucesso!</div>';
                    e.target.reset();
                } else {
                    throw new Error('Erro no upload do documento');
                }
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });

        // Carregar carros quando a p√°gina carrega
        loadCars();
    </script>
</body>
</html>